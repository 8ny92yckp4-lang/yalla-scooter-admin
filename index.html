saveTrip: async function(isIssue = false) {
            // 1. جلب القيم والتأكد من وجودها
            const staff = document.getElementById('staff').value;
            const scooter = document.getElementById('scooter').value.toUpperCase();
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;

            if(!staff || !scooter || !start || !end) {
                return alert("⚠️ من فضلك أكمل كل البيانات (الموظف، السكوتر، والوقت)");
            }

            let reason = "سليم";
            let discount = 0;

            if(isIssue) {
                const pReason = prompt("ما هو سبب العطل؟");
                if (pReason === null) return; // إلغاء العملية لو داس Cancel
                reason = pReason || "عطل غير محدد";
                
                const pDiscount = prompt("قيمة الخصم؟ (اكتب 0 لو لا يوجد)");
                discount = parseFloat(pDiscount) || 0; // التأكد أن الخصم رقم وليس NaN
            }

            // 2. حساب الدقائق بطريقة آمنة جداً
            const timeStart = start.split(':');
            const timeEnd = end.split(':');
            
            let d1 = new Date(2026, 0, 1, timeStart[0], timeStart[1]);
            let d2 = new Date(2026, 0, 1, timeEnd[0], timeEnd[1]);

            if (d2 < d1) d2.setDate(d2.getDate() + 1); // لو الوقت عبر منتصف الليل

            const mins = Math.floor((d2 - d1) / 60000);
            const cost = Math.max(0, (mins * 2) - discount);

            if (isNaN(mins) || isNaN(cost)) {
                return alert("⚠️ خطأ في حساب الوقت أو الخصم، يرجى التأكد من المدخلات");
            }

            // 3. التجهيز للحفظ
            const tripData = {
                staff: staff,
                scooter: scooter,
                start: start,
                end: end,
                mins: mins,
                cost: cost,
                discount: discount,
                reason: reason,
                timestamp: firebase.database.ServerValue.TIMESTAMP // إضافة وقت السيرفر للترتيب
            };

            // 4. الحفظ في تاريخ اليوم الفعلي
            const today = new Date().toISOString().split('T')[0];

            if(confirm(`ملخص الرحلة:\nمدة: ${mins} دقيقة\nصافي: ${cost} جنيه\n\nتأكيد الحفظ؟`)) {
                try {
                    await db.ref('history/' + today).push(tripData);
                    alert("✅ تم الحفظ بنجاح");
                    
                    // تنظيف الحقول
                    document.getElementById('scooter').value = "";
                    document.getElementById('startTime').value = "";
                    document.getElementById('endTime').value = "";
                    localStorage.setItem('yStaff', staff);
                } catch(e) { 
                    console.error(e);
                    alert("❌ فشل الاتصال بقاعدة البيانات: " + e.message); 
                }
            }
        },
